<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản Lý Khóa Học • JSON driven</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- jQuery & DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <style>
    /* Custom styles that can't be replaced with Tailwind */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Be Vietnam Pro', sans-serif;
    }

    /* Desktop: Disable body scroll */
    @media (min-width: 1201px) {
      body {
        height: 100vh;
        overflow: hidden;
      }
    }

    /* DataTables custom styles */
    #courses thead th {
      background: #2EC7BE !important;
      color: #fff !important;
      font-weight: 700 !important;
      font-size: 18px !important;
      position: sticky;
      top: 80px;
      z-index: 50;
      box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
      border-bottom: 2px solid #178a7a !important;
    }

    @media (min-width: 1201px) {
      #courses thead th {
        top: 0;
      }
    }

    #courses tbody td {
      color: #1D3F59;
      font-size: 15px;
    }

    #courses tbody tr:hover {
      background: #f1f5f9;
      cursor: pointer;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: #64748b;
      font-size: .85rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin: 0 .25rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background: #4f46e5 !important;
      color: #fff !important;
    }

    .dataTables_scrollHead {
      position: sticky;
      top: 80px;
      z-index: 45;
      background: #fff;
    }

    @media (min-width: 1201px) {
      .dataTables_scrollHead {
        top: 0;
      }
    }

    /* Custom scrollbar for mobile */
    @media (max-width: 1200px) {
      body {
        scrollbar-width: thin;
        scrollbar-color: rgba(79, 70, 229, 0.4) transparent;
      }
      
      body::-webkit-scrollbar {
        width: 8px;
      }
      
      body::-webkit-scrollbar-track {
        background: transparent;
      }
      
      body::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, rgba(79, 70, 229, 0.6) 0%, rgba(124, 58, 237, 0.6) 100%);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, rgba(79, 70, 229, 0.8) 0%, rgba(124, 58, 237, 0.8) 100%);
      }
    }

    /* Tile scrollbar */
    .upcoming-tile ul {
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.3) transparent;
    }

    .upcoming-tile ul::-webkit-scrollbar {
      width: 6px;
    }

    .upcoming-tile ul::-webkit-scrollbar-track {
      background: transparent;
    }

    .upcoming-tile ul::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,.3);
      border-radius: 3px;
    }

    .upcoming-tile ul::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255,255,255,.5);
    }

    /* HN tile scrollbar */
    #tile-hn ul {
      scrollbar-color: rgba(57, 131, 152, 0.6) transparent;
    }

    #tile-hn ul::-webkit-scrollbar-thumb {
      background-color: rgba(57, 131, 152, 0.6);
    }

    #tile-hn ul::-webkit-scrollbar-thumb:hover {
      background-color: rgba(57, 131, 152, 0.6);
    }

    /* Animations */
    @keyframes slideInUp {
      from {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideOutDown {
      from {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      to {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
      }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-4px);
      }
      60% {
        transform: translateY(-2px);
      }
    }

    .mobile-scroll-indicator.visible {
      display: flex !important;
      animation: slideInUp 0.4s ease-out;
    }

    .mobile-scroll-indicator.hiding {
      animation: slideOutDown 0.3s ease-in forwards;
    }

    .mobile-scroll-indicator-icon {
      animation: bounce 2s infinite;
    }

    /* Tile divider animation */
    .tile-divider {
      position: absolute;
      top: 46px;
      left: 0;
      width: 100%;
      height: 2px;
      background: rgba(255,255,255,.5);
    }

    #tile-hn .tile-divider {
      background: rgba(57, 131, 152, 0.2);
    }

    #tile-hcm .tile-divider {
      background: rgba(29, 63, 89, 0.1);
    }

    #tile-other .tile-divider {
      background: rgba(29, 63, 89, 0.1);
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'vietnam': ['Be Vietnam Pro', 'sans-serif'],
          },
          colors: {
            'primary': '#4f46e5',
            'teal': '#2EC7BE',
            'teal-dark': '#178a7a',
            'navy': '#1D3F59',
            'zoom-blue': '#2D8CFF',
          },
        }
      }
    }
  </script>
</head>
<body class="bg-white text-gray-900 p-6 min-h-screen lg:h-screen lg:overflow-hidden">
  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg lg:h-[calc(100vh-3rem)] lg:flex lg:flex-col">
    
    <!-- Header -->


    <!-- Main Content -->
    <main class="p-0 lg:p-8 lg:flex-1 lg:flex lg:flex-col lg:overflow-hidden">
      
      <!-- Mobile Introduction Section -->
      <section class="hidden max-lg:flex flex-col gap-5 mb-6">
        <div class="text-center px-2">
          <h1 class="text-3xl md:text-4xl font-bold text-[#1e5a6f] mb-2 leading-tight">
            Lịch sự kiện và các khóa học tại BKE
          </h1>
          <p class="text-sm text-slate-600 leading-relaxed">
            Là sự kết hợp giữa <strong class="text-[#1e5a6f] font-semibold">khoa học & đạo học</strong><br>
            dựa trên nền tảng của 3 GỐC RỄ: <strong class="text-[#1e5a6f] font-semibold">Đạo Đức-Trí Tuệ-Nghị Lực</strong>
          </p>
        </div>

        <!-- Info Card -->
        <div class="bg-teal rounded-2xl p-5 shadow-lg text-white max-w-[95%] mx-auto">
          <h2 class="text-lg font-bold mb-4 text-left leading-snug">
            Bạn chưa biết bắt đầu từ đâu?
          </h2>
          <div class="flex items-start gap-3 mb-5">
            <img src="https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/lotrinh-20220213045012.svg" alt="Lộ trình" class="w-11 h-11 flex-shrink-0">
            <p class="text-sm leading-relaxed flex-1">
              Tham khảo hành trình học tập <strong class="font-bold">hiệu quả</strong> của BKE
            </p>
          </div>
          <a href="https://bke.edu.vn/hanhtrinh/" target="_blank" 
             class="inline-flex items-center justify-center gap-2 bg-white text-teal px-7 py-3 rounded-full font-semibold text-sm transition-all hover:shadow-lg hover:-translate-y-0.5 hover:bg-gray-50 mx-auto">
            Tại đây <i class="fas fa-arrow-right text-xs"></i>
          </a>
        </div>

        <!-- Action Buttons - LUÔN NGANG TRÊN MOBILE -->
        <div class="flex gap-3 px-1">
          <button class="intro-action-btn flex-1 flex flex-col items-center justify-center gap-2 p-3.5 border-2 border-slate-300 rounded-xl bg-white text-gray-900 text-xs font-semibold cursor-pointer transition-all hover:border-teal hover:text-teal hover:-translate-y-0.5 hover:shadow-md active:border-teal active:text-teal leading-tight">
            <i class="fas fa-user-circle text-2xl text-gray-900 transition-colors"></i>
            <span class="text-center break-words">Hướng dẫn ghi danh</span>
          </button>
          <button class="intro-action-btn-share flex-1 flex flex-col items-center justify-center gap-2 p-3.5 border-2 border-slate-300 rounded-xl bg-white text-gray-900 text-xs font-semibold cursor-pointer transition-all hover:border-teal hover:text-teal hover:-translate-y-0.5 hover:shadow-md active:border-teal active:text-teal leading-tight">
            <i class="fas fa-users text-2xl text-gray-900 transition-colors"></i>
            <span class="text-center break-words">Các buổi chia sẻ cộng đồng</span>
          </button>
        </div>
      </section>

      <!-- Desktop Highlights -->
      <section id="desktopHighlights" class="hidden lg:grid lg:grid-cols-4 gap-5 mb-6"></section>

      <!-- Search Section -->
      <section class="sticky top-0 z-[100] bg-white px-8 py-4 -mx-8 mb-8 shadow-md lg:static lg:px-0 lg:py-0 lg:mb-6 lg:shadow-none">
        <div class="relative max-w-2xl mx-auto">
          <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input id="globalSearch" 
                 class="w-full pl-12 pr-5 py-3.5 border-2 border-gray-200 rounded-full text-sm transition-all focus:outline-none focus:border-primary focus:shadow-lg focus:-translate-y-0.5 bg-white placeholder:text-gray-400 placeholder:font-normal" 
                 placeholder="Tìm kiếm thông tin khóa học, giảng viên, địa điểm..."
                 autocomplete="off">
        </div>
      </section>

      <!-- Desktop Table -->
      <div class="hidden lg:flex lg:flex-1 lg:flex-col lg:overflow-hidden">
        <div class="flex-1 overflow-y-auto rounded-lg shadow-sm">
          <table id="courses" class="display nowrap w-full">
            <thead>
              <tr>
                <th class="text-center p-4">KHÓA HỌC</th>
                <th class="text-center p-4">GIẢNG VIÊN</th>
                <th class="text-center p-4">THỜI GIAN</th>
                <th class="text-center p-4">ĐỊA ĐIỂM</th>
                <th class="text-center p-4">HÌNH THỨC</th>
              </tr>
            </thead>
            <tbody class="text-center"></tbody>
          </table>
        </div>
      </div>

      <!-- Mobile Cards -->
      <div id="mobileCardContainer" class="flex lg:hidden flex-col gap-6"></div>
    </main>
  </div>

  <!-- Mobile Scroll Indicator -->
  <div id="mobileScrollIndicator" 
       class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-teal/70 backdrop-blur-md text-white px-4 py-3 rounded-full shadow-lg hidden items-center gap-2 text-sm font-medium z-[1000] border border-white/20 max-w-[calc(100vw-2.5rem)] lg:!hidden">
    <i class="fas fa-chevron-down mobile-scroll-indicator-icon text-base"></i>
    <span class="mobile-scroll-indicator-text whitespace-nowrap">Vuốt để xem thêm</span>
  </div>

<script>
  const specialCourses = ["Chánh Kiến 1", "Nhân Tướng Học", "Rèn Trí Sáng Suốt", "Rèn Tâm Vững Vàng"];

  const stripVN = str =>
    (str || '')
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/đ/g, 'd').replace(/Đ/g, 'D')
      .replace(/[^\w\s]/g, '')
      .toLowerCase();

  const VND = n => (n || 0).toLocaleString('vi-VN') + ' vnđ';
  const parseNum = t => parseInt(String(t).replace(/[^\d]/g, '')) || 0;

  const createModeBadge = mode => {
    const online = /online|zoom|trực tuyến/i.test(mode);
    const hybrid = /hybrid|kết hợp/i.test(mode) || /offline và zoom/i.test(mode);
    let cls, icon, bgColor, textColor;
    if (online) {
      cls = 'online';
      icon = 'fa-video';
      bgColor = 'bg-blue-50';
      textColor = 'text-zoom-blue';
    } else if (hybrid) {
      cls = 'hybrid';
      icon = 'fa-people-arrows';
      bgColor = 'bg-amber-50';
      textColor = 'text-amber-600';
    } else {
      cls = 'offline';
      icon = 'fa-chalkboard-teacher';
      bgColor = 'bg-teal/10';
      textColor = 'text-teal';
    }
    return `<span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium ${bgColor} ${textColor}">
      <i class="fas ${icon}"></i> ${mode || '?'}
    </span>`;
  };

  $.fn.dataTable.ext.type.order['ddmmyyyy-pre'] = d => {
    if (!d || d.includes('--')) return 0;
    const [dd, mm, yyyy] = d.split('/') || [];
    return new Date(yyyy, mm - 1, dd).getTime() || 0;
  };
  $.fn.dataTable.ext.type.order['vnd-pre'] = t => parseNum(t);

  $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
    const query = stripVN($('#globalSearch').val().trim().toLowerCase());
    if (!query) return true;
    return Object.values(rowData).some(val => {
      if (typeof val === 'number') {
        return stripVN(VND(val)).includes(query) || String(val).includes(query);
      }
      const text = typeof val === 'string' ? val : String(val);
      return stripVN($('<div>').html(text).text()).includes(query);
    });
  });

  async function getData() {
    let rawData;
    try {
      const res = await fetch('https://webhook.gnh.vn/webhook/event_info', { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status);
      rawData = await res.json();
    } catch (err) {
      console.warn('API lỗi, dùng dữ liệu demo:', err);
      rawData = [{"start_date": "05/06/2025", "end_date": "06/06/2025", "speaker": "Thầy Trần Việt Quân", "course": "Hội Khai Minh 3 Gốc", "location": "Hà Nội", "learning_mode": "Offline và Zoom", "categories": "Hành trình 3 Gốc", "tuition": "Liên hệ", "href": "https://bke.edu.vn/hoikhaiminh", "thumbnail": "https://w.ladicdn.com/s292x164/5e8449c2481e7d0f79868b5d/screenshot_1732285943-20241123021730-ktan9.png", "description": "Một chương trình 12 tháng đồng hành kết hợp online và offline, giúp bạn chuyển hóa tâm thức theo chiều sâu"}, {"start_date": "07/06/2025", "end_date": "08/06/2025", "speaker": "Thầy Trần Việt Quân", "course": "Chánh Kiến 2", "location": "Hà Nội", "learning_mode": "Offline", "categories": "Hành trình 3 Gốc", "tuition": "2.900.000", "href": "https://bke.edu.vn/chanhkien2", "thumbnail": "https://w.ladicdn.com/s292x164/5e8449c2481e7d0f79868b5d/ck2-01-20220214103634.jpg", "description": "Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình"}, {"start_date": "11/06/2025", "end_date": "12/06/2025", "speaker": "Thầy Trần Việt Quân", "course": "Rèn Tâm Vững Vàng", "location": "Hà Nội", "learning_mode": "Offline", "categories": "Lãnh đạo chính mình - Tỉnh thức", "tuition": "11.900.000", "href": "https://bke.edu.vn/rentam", "thumbnail": "https://w.ladicdn.com/s600x500/5e8449c2481e7d0f79868b5d/rentam-20250505024647-oievi.png", "description": "Bí mật trí tuệ cảm xúc ứng dụng - bình an trong giông bão. Học tại lớp 2 ngày offline + 6 tuần online & thực hành liên tục trong đời sống"}, {"start_date": "14/06/2025", "end_date": "15/06/2025", "speaker": "Thầy Trần Việt Quân", "course": "Chánh Kiến 1", "location": "Hồ Chí Minh", "learning_mode": "Offline", "categories": "Hành trình 3 Gốc", "tuition": "1.900.000", "href": "https://bke.edu.vn/chanh-kien-1#dang_ky", "thumbnail": "https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/ck1-banner-01-20220602030602.jpg", "description": "Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình."}];
    }
    
    return rawData
      .filter(x => x.course && x.speaker)
      .map(x => {
        let processedFee;
        const tuitionStr = String(x.tuition || '').trim();
        if (!tuitionStr) {
          processedFee = "--";
        } else if (/[a-zA-Z]/i.test(tuitionStr)) {
          processedFee = tuitionStr;
        } else {
          processedFee = parseNum(tuitionStr);
        }
        const endDate = x.end_date || x.start_date;
        return {
          start: x.start_date || '--/--/----',
          end: endDate || '--/--/----',
          speaker: x.speaker,
          course: x.course,
          loc: x.location || 'N/A',
          mode: x.learning_mode || 'N/A',
          fee: processedFee,
          href: x.href || '#',
          thumbnail: x.thumbnail || '',
          description: x.description || '',
          categories: x.categories || ''
        };
      });
  }

  function fillCards(data) {
    const container = $('#mobileCardContainer').empty();
    if (!data || !data.length) {
      container.html('<p class="text-center p-6 text-gray-500">Không tìm thấy khóa học phù hợp.</p>');
      return;
    }
    
    const sortedData = [...data].sort((a, b) => {
      const parseDate = (dateStr) => {
        if (!dateStr || dateStr.includes('--')) return new Date(0);
        const [dd, mm, yyyy] = dateStr.split('/');
        return new Date(yyyy, mm - 1, dd);
      };
      return parseDate(a.start).getTime() - parseDate(b.start).getTime();
    });
    
    const getModeBadgeClass = mode => {
      const online = /online|zoom|trực tuyến/i.test(mode);
      const hybrid = /hybrid|kết hợp/i.test(mode) || /offline và zoom/i.test(mode);
      return online ? 'bg-blue-50 text-zoom-blue' : hybrid ? 'bg-amber-50 text-amber-600' : 'bg-teal/10 text-teal';
    };
    
    const getModeIcon = mode => {
      const online = /online|zoom|trực tuyến/i.test(mode);
      const hybrid = /hybrid|kết hợp/i.test(mode) || /offline và zoom/i.test(mode);
      return online ? 'fa-video' : hybrid ? 'fa-people-arrows' : 'fa-chalkboard-teacher';
    };
    
    container.html(sortedData.map(c => {
      const isSpecial = specialCourses.includes(c.course);
      const specialClass = isSpecial ? 'text-red-600 font-bold' : '';

      const formatDM = d => {
        if (!d || d.includes('--')) return '??/??';
        const [dd, mm] = d.split('/');
        return `${dd}/${mm}`;
      };
      
      const dateDisplay = c.start === c.end ? formatDM(c.start) : `${formatDM(c.start)} - ${formatDM(c.end)}`;

      return `
      <article class="border border-gray-200 rounded-xl shadow-md overflow-hidden bg-white transition-transform hover:-translate-y-0.5 hover:shadow-lg">
        <div class="relative w-full h-0 pb-[56.9%] overflow-hidden bg-gradient-to-r from-primary to-purple-600">
          ${c.thumbnail ? 
            `<img src="${c.thumbnail}" alt="${c.course}" class="absolute top-0 left-0 w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
             <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-primary to-purple-600 flex items-center justify-center text-white font-semibold text-lg text-center p-4" style="display:none;">${c.course}</div>` : 
            `<div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-primary to-purple-600 flex items-center justify-center text-white font-semibold text-lg text-center p-4">${c.course}</div>`
          }
        </div>
        
        <div class="p-5 pt-0">
          <h3 class="text-gray-900 text-lg font-semibold my-4 leading-snug ${specialClass}">${c.course}</h3>
        </div>
        
        <div class="px-5 pb-5">
          <div class="flex items-center gap-4 mb-4 flex-wrap">
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium uppercase ${getModeBadgeClass(c.mode)}">
              <i class="fas ${getModeIcon(c.mode)}"></i>
              ${c.mode}
            </span>
          </div>
          
          <div class="grid gap-3 mb-5">
            <div class="flex items-center gap-2 text-gray-600 text-sm">
              <i class="fas fa-user text-primary w-4 text-center"></i>
              <span class="text-gray-900 font-medium">${c.speaker}</span>
            </div>
            <div class="flex items-center gap-2 text-gray-600 text-sm">
              <i class="fas fa-calendar text-primary w-4 text-center"></i>
              <span class="text-gray-900 font-medium">${dateDisplay}</span>
            </div>
            <div class="flex items-center gap-2 text-gray-600 text-sm">
              <i class="fas fa-map-marker-alt text-primary w-4 text-center"></i>
              <span class="text-gray-900 font-medium">${c.loc}</span>
            </div>
            ${c.categories ? `
            <div class="flex items-center gap-2 text-gray-600 text-sm">
              <i class="fas fa-tag text-primary w-4 text-center"></i>
              <span class="text-gray-900 font-medium">${c.categories}</span>
            </div>` : ''}
          </div>
          
          <div class="text-xl font-bold text-red-600 mb-4">${typeof c.fee === 'string' ? c.fee : VND(c.fee)}</div>
          
          ${c.description ? `<div class="text-gray-600 text-sm leading-relaxed mb-5 break-words">${c.description.replace(/\n/g, '<br>')}</div>` : ''}
        </div>
        
        <div class="px-5 pb-5 flex gap-3">
          <a href="${c.href}" target="_blank" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition-all hover:bg-green-700 hover:-translate-y-0.5 text-center text-sm">Đăng ký ngay</a>
          <a href="${c.href}" target="_blank" class="bg-transparent text-primary px-4 py-3 border border-primary rounded-lg font-medium transition-all hover:bg-primary hover:text-white text-sm">Chi tiết</a>
        </div>
      </article>`}).join(''));

    if (window.updateMobileScrollIndicator) {
      setTimeout(window.updateMobileScrollIndicator, 100);
    }
  }

  const debounce = (fn, ms = 250) => {
    let id;
    return (...args) => {
      clearTimeout(id);
      id = setTimeout(() => fn.apply(this, args), ms);
    };
  };

  function renderHighlights(courseData){
    const container = $('#desktopHighlights').empty();
    if($(window).width()<1200) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const parseDate = (d)=>{ if(!d||d.includes('--')) return null; const [dd,mm,yy]=d.split('/'); return new Date(yy,mm-1,dd); };

    const groups = [
      {id:'hcm',label:'Tại Hồ Chí Minh', bg:'bg-[#FFFBEC]', text:'text-navy', match: c=>/Hồ Chí Minh/i.test(c.loc)},
      {id:'hn', label:'Tại Hà Nội', bg:'bg-[#E3FFFF]', text:'text-[#398398]', match: c=>/Hà Nội/i.test(c.loc)},
      {id:'other',label:'Tỉnh/Thành Phố Khác', bg:'bg-[#FFEBFC]', text:'text-navy', match: c=>!/(Hồ Chí Minh|Hà Nội|Zoom)/i.test(c.loc) && !/online/i.test(c.mode)},
      {id:'online',label:'Trực Tuyến Qua Zoom', bg:'bg-blue-500', text:'text-white', match: c=>/zoom/i.test(c.loc) || /online/i.test(c.mode)}
    ];

    let htmls = [];
    groups.forEach(g=>{
      const list = courseData
        .filter(c=>g.match(c))
        .sort((a,b)=>parseDate(a.start)-parseDate(b.start));

      const formatDM = d=>{const [dd,mm] = d.split('/'); return `${dd}/${mm}`};
      
      if (g.id === 'other') {
        const itemsWithLocation = list.map(c => {
          const specialClass = specialCourses.includes(c.course) ? 'text-red-600 font-bold' : '';
          const dateDisplay = c.start === c.end ? formatDM(c.start) : `${formatDM(c.start)} – ${formatDM(c.end)}`;
          return `<li class="flex justify-between items-baseline gap-2">
            <div class="flex-1">
              <a href="${c.href}" target="_blank" class="${g.text} no-underline transition-opacity hover:opacity-70 text-[15px] ${specialClass}">${c.course}</a>
              <span class="${g.text === 'text-white' ? 'text-white/80' : g.text} ml-1.5 text-[15px]">(${c.loc})</span>
            </div>
            <span class="${g.text} whitespace-nowrap text-[15px]">${dateDisplay}</span>
          </li>`;
        }).join('');
        htmls.push(`
          <article id="tile-${g.id}" class="${g.bg} ${g.text} rounded-xl p-6 shadow-md relative overflow-hidden">
            <h3 class="text-lg font-bold m-0 mb-3 text-center leading-snug">${g.label}</h3>
            <div class="tile-divider"></div>
            <ul class="list-none m-0 pt-2 text-sm leading-normal max-h-[180px] overflow-auto space-y-2">${itemsWithLocation || '<li>Đang cập nhật…</li>'}</ul>
          </article>`);
      } else {
        const items = list.map(c => {
          const specialClass = specialCourses.includes(c.course) ? (g.id === 'online' ? 'text-white font-bold' : 'text-red-600 font-bold') : '';
          const dateDisplay = c.start === c.end ? formatDM(c.start) : `${formatDM(c.start)} – ${formatDM(c.end)}`;
          return `<li class="flex justify-between items-baseline gap-2">
            <a href="${c.href}" target="_blank" class="flex-1 ${g.text} no-underline transition-opacity hover:opacity-70 break-words text-[15px] ${specialClass}">${c.course}</a>
            <span class="${g.text} whitespace-nowrap text-[15px]">${dateDisplay}</span>
          </li>`;
        }).join('');
        htmls.push(`
          <article id="tile-${g.id}" class="${g.bg} ${g.text} rounded-xl p-6 shadow-md relative overflow-hidden">
            <h3 class="text-lg font-bold m-0 mb-3 text-center leading-snug">${g.label}</h3>
            <div class="tile-divider"></div>
            <ul class="list-none m-0 pt-2 text-sm leading-normal max-h-[180px] overflow-auto space-y-2">${items || '<li>Đang cập nhật…</li>'}</ul>
          </article>`);
      }
    });
    container.html(htmls.join(''));
  }

  $(async () => {
    const allCourseData = await getData();
    
    $('.intro-action-btn').on('click', function() {
      window.open('https://bke.edu.vn/huongdanghidanh', '_blank');
    });

    $('.intro-action-btn-share').on('click', function() {
      window.open('https://bke.edu.vn/chiasecongdong/', '_blank');
    });

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const parseDateForFilter = (dateStr) => {
        if (!dateStr || dateStr.includes('--')) return null;
        const [dd, mm, yyyy] = dateStr.split('/');
        return new Date(yyyy, mm - 1, dd);
    };
    const courseData = allCourseData.filter(course => {
      const endDate = parseDateForFilter(course.end);
      return endDate ? endDate.getTime() >= today.getTime() : false;
    });

    fillCards(courseData);
    renderHighlights(courseData);
    initMobileScrollIndicator();

    const dt = $('#courses').DataTable({
      data: courseData,
      columns: [
        { data: 'course' },
        { data: 'speaker' },
        { data: null },
        { data: 'loc' },
        { data: 'mode' },
        { data: 'start', visible: false },
        { data: 'end', visible: false }
      ],
      columnDefs: [
        {
          targets: 2,
          orderData: [5],
          render: function (data, type, row) {
            const formatDM = d => {
              if (!d || d.includes('--')) return '??/??';
              const [dd, mm] = d.split('/');
              return `${dd}/${mm}`;
            };
            return row.start === row.end ? formatDM(row.start) : `${formatDM(row.start)} - ${formatDM(row.end)}`;
          }
        },
        { type: 'ddmmyyyy', targets: [5] },
        {
          targets: 3,
          render: (data) => `${data} ${/^\+?\d/.test(data.trim()) ? `<a href="tel:${data.trim()}" class="text-primary ml-2 no-underline" title="Gọi điện"><i class="fas fa-phone"></i></a>` : ''}`
        },
        { targets: 4, render: (d) => createModeBadge(d) }
      ],
      createdRow: (row, data) => {
        $(row).attr('data-href', data.href);
        if (specialCourses.includes(data.course)) {
          $('td:eq(0)', row).addClass('text-red-600 font-bold');
        }
      },
      order: [[2, 'asc']],
      pageLength: -1,
      lengthMenu: [],
      dom: 'rt',
      info: false,
      paging: false,
      autoWidth: false,
      initComplete: function() {
        const isDesktop = window.innerWidth > 1200;
        const topValue = isDesktop ? '0px' : '80px';
        $('#courses thead th').css('top', topValue);
      },
      drawCallback: function() {
        const isDesktop = window.innerWidth > 1200;
        const topValue = isDesktop ? '0px' : '80px';
        $('#courses thead th').css('top', topValue);
      }
    });

    $('#globalSearch').on('input', debounce(function () {
      dt.search('').draw();
    }));

    $(window).on('resize', debounce(function() {
      const isDesktop = window.innerWidth > 1200;
      const topValue = isDesktop ? '0px' : '80px';
      $('#courses thead th').css('top', topValue);
      $('.dataTables_scrollHead').css('top', topValue);
    }, 250));

    dt.on('draw.dt', () => {
      fillCards(dt.rows({ search: 'applied' }).data().toArray());
      if (window.updateMobileScrollIndicator) {
        setTimeout(window.updateMobileScrollIndicator, 100);
      }
    });

    $('#courses tbody').on('click', 'tr', function (e) {
      if ($(e.target).closest('a').length) return;
      const href = $(this).data('href');
      if (href && href !== '#') window.open(href, '_blank');
    });

    function initMobileScrollIndicator() {
      const $indicator = $('#mobileScrollIndicator');
      const $mobileContainer = $('#mobileCardContainer');
      let isIndicatorVisible = false;
      let hideTimeout;

      function isMobileView() {
        return window.innerWidth <= 1200;
      }

      function hasScrollableContent() {
        return document.documentElement.scrollHeight > window.innerHeight + 100;
      }

      function isNearBottom() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const distanceFromBottom = documentHeight - (scrollTop + windowHeight);
        return distanceFromBottom <= 150;
      }

      function showIndicator() {
        if (isIndicatorVisible) return;
        $indicator.removeClass('hiding').addClass('visible');
        isIndicatorVisible = true;
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
      }

      function hideIndicator() {
        if (!isIndicatorVisible) return;
        $indicator.removeClass('visible').addClass('hiding');
        isIndicatorVisible = false;
        hideTimeout = setTimeout(() => {
          $indicator.removeClass('hiding');
        }, 300);
      }

      function updateIndicatorVisibility() {
        if (!isMobileView()) {
          hideIndicator();
          return;
        }
        if (hasScrollableContent() && !isNearBottom() && $mobileContainer.children().length > 0) {
          showIndicator();
        } else {
          hideIndicator();
        }
      }

      let scrollTimeout;
      function throttledScrollHandler() {
        if (scrollTimeout) return;
        scrollTimeout = setTimeout(() => {
          updateIndicatorVisibility();
          scrollTimeout = null;
        }, 16);
      }

      $(window).on('scroll', throttledScrollHandler);
      $(window).on('resize', debounce(updateIndicatorVisibility, 250));
      updateIndicatorVisibility();
      window.updateMobileScrollIndicator = updateIndicatorVisibility;
    }
  });
</script>
</body>
</html>
