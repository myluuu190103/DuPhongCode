
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản Lý Khóa Học • JSON driven</title>

  <!-- ▸ Styles & fonts -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- ▸ Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <style>
    /* ====== Theme Variables ====== */
    :root {
      --primary-color: #4f46e5;
      --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      --secondary-color: #64748b;
      --bg-primary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #6b7280;
      --border-light: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --transition: all 0.2s ease;
    }

    /* ====== Global Styles ====== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Be Vietnam Pro', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      padding: 1.5rem;
      min-height: 100vh;
    }

    /* Desktop: Disable body scroll */
    @media (min-width: 1201px) {
      body {
        height: 100vh;
        overflow: hidden;
        padding: 1.5rem;
      }
    }

    /* ====== Layout Containers ====== */
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      /* Bỏ overflow: hidden để sticky có thể hoạt động */
    }

    /* Desktop: Full height app container */
    @media (min-width: 1201px) {
      .app-container {
        height: calc(100vh - 3rem); /* Subtract body padding */
        display: flex;
        flex-direction: column;
      }
    }

    .app-header {
      background: var(--primary-gradient);
      color: #fff;
      padding: 2rem;
      text-align: center;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      /* Bỏ sticky - cho phép scroll qua */
    }
    .app-header h1 { font-size: 2rem; font-weight: 700; margin-bottom: .5rem; }
    .app-header .subtitle { opacity: .9; }

    .content-area { 
      padding: 0 2rem 2rem; 
      border-radius: var(--radius-md);
      background: var(--bg-card);
    }

    /* Desktop: Flexible content area */
    @media (min-width: 1201px) {
      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 2rem;
      }
    }

    /* ====== Search ====== */
    .search-section { 
      /* Sticky positioning - ghim khi scroll */
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-primary);
      padding: 1rem 2rem;
      margin: -2rem -2rem 2rem -2rem;
      /* Thêm shadow để tách biệt khi sticky */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Desktop: Static search section */
    @media (min-width: 1201px) {
      .search-section {
        position: static;
        background: transparent;
        padding: 0 0 1.5rem 0;
        margin: 0 0 1.5rem 0;
        box-shadow: none;
        flex-shrink: 0;
      }
    }
    .search-container { position: relative; max-width: 523333330px; }
    .search-input {
      width: 100%;
      padding: 0.875rem 1.25rem 0.875rem 3rem;
      border: 2px solid #e2e8f0;
      border-radius: 50px; /* Bo tròn hoàn toàn */
      font-size: .95rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.06);
      background: #ffffff;
    }
    .search-input:focus { 
      outline: none; 
      border-color: var(--primary-color); 
      box-shadow: 0 4px 20px rgba(79, 70, 229, 0.15), 0 2px 8px rgba(79, 70, 229, 0.1);
      transform: translateY(-1px);
    }
    .search-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }
    .search-icon { 
      position: absolute; 
      left: 1.125rem; 
      top: 50%; 
      transform: translateY(-50%); 
      color: var(--text-muted);
      font-size: 1rem;
    }

    /* ====== Table ====== */
    .table-container { 
      border-radius: var(--radius-sm); 
      box-shadow: var(--shadow-sm);
      position: relative;
      /* Bỏ overflow: hidden để table headers có thể sticky */
    }

    /* Desktop: Scrollable table container */
    @media (min-width: 1201px) {
      .desktop-table {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .table-container {
        flex: 1;
        overflow-y: auto;
        max-height: 100%;
      }
    }
    
    /* ====== DataTables wrapper fixes ====== */
    .dataTables_wrapper {
      position: relative;
    }
    
    .dataTables_scroll {
      position: relative;
    }
    
    .dataTables_scrollHead,
    .dataTables_scrollHeadInner {
      position: relative;
    }
    
    .dataTables_scrollBody {
      position: relative;
    }
    
    #courses { 
      width: 100%; 
      border-collapse: separate;
      border-spacing: 0;
    }
    
    #courses thead th {
      background: #2EC7BE; /* Màu xanh ngọc nhạt */
      color: #fff;
      padding: 1rem;
      font-weight: 700; /* In đậm */
      font-size: 18px;  /* Tăng cỡ chữ */
      text-align: center;
      /* Sticky header - dính dưới search bar */
      position: sticky;
      top: 80px; /* Chiều cao của search section */
      z-index: 50;
      /* Thêm để tránh border issues */
      box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
      border-bottom: 2px solid #178a7a; /* Viền đậm hơn một chút */
    }

    /* Desktop: Table header sticky within container */
    @media (min-width: 1201px) {
      #courses thead th {
        top: 0; /* Sticky to top of table container */
      }
    }
    #courses tbody td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-light);
      color: #1D3F59; /* Đổi màu chữ trong data table */
      text-align: center;
      font-size: 15px; /* Thêm font-size cho nội dung table */
    }
    #courses tbody tr:hover { background: #f1f5f9; cursor: pointer; }

    .tuition { font-weight: 600; color: #177991; }

    /* ====== Mode Badges ====== */
    .mode-badge { padding: .4rem .8rem; border-radius: var(--radius-sm); font-size: .85rem; font-weight: 500; }
    .mode-badge.online  { background: rgba(45, 140, 255, 0.1); color: #2D8CFF; } /* Màu xanh dương Zoom */
    .mode-badge.hybrid  { background: rgba(245,158,11,.1); color: #f59e0b; }
    .mode-badge.offline { background: rgba(32, 178, 170, 0.1); color: #2EC7BE; } /* Màu xanh ngọc nhạt */

    /* ====== Mobile Cards ====== */
    .mobile-card-container { display: none; flex-direction: column; gap: 1.5rem; }
    .course-card { 
      border: 1px solid #e2e8f0; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
      overflow: hidden; 
      background: #fff;
      transition: var(--transition);
    }
    .course-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    /* Fixed image container with proper aspect ratio */
    .card-thumbnail-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.9%; /* 164.5/288.99 * 100% ≈ 56.9% */
      overflow: hidden;
      background: var(--primary-gradient);
    }
    .card-thumbnail {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .card-thumbnail-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
      padding: 1rem;
    }
    
    /* Card content now separate from image */
    .card-header {
      padding: 1.25rem 1.25rem 0;
    }
    .card-title {
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
      line-height: 1.4;
    }
    
    .card-body { padding: 0 1.25rem 1.25rem; }
    .card-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .card-mode-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
    }
    .card-mode-badge.online {
      background: rgba(45, 140, 255, 0.1); /* Nền xanh dương nhạt cho Zoom */
      color: #2D8CFF; /* Màu xanh dương Zoom */
    }
    .card-mode-badge.offline {
      background: rgba(32, 178, 170, 0.1); /* Nền xanh ngọc nhạt */
      color: #2EC7BE; /* Màu xanh ngọc nhạt */
    }
    .card-mode-badge.hybrid {
      background: #fef3c7;
      color: #92400e;
    }
    
    .card-info-grid {
      display: grid;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    .card-info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    .card-info-item .info-icon {
      color: var(--primary-color);
      width: 16px;
      text-align: center;
    }
    .card-info-item .info-value {
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .card-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: #dc2626;
      margin-bottom: 1rem;
    }
    
    .card-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 1.25rem;
      word-wrap: break-word;
      hyphens: auto;
    }
    
    .card-footer { 
      padding: 0 1.25rem 1.25rem; 
      display: flex;
      gap: 0.75rem;
    }
    .card-register-btn { 
      flex: 1;
      background: #16a34a; 
      color: #fff; 
      padding: 0.75rem 1rem; 
      border-radius: 8px; 
      text-decoration: none; 
      font-weight: 600; 
      transition: var(--transition);
      text-align: center;
      font-size: 0.9rem;
    }
    .card-register-btn:hover { 
      background: #15803d; 
      transform: translateY(-1px);
    }
    .card-details-btn { 
      background: transparent; 
      color: var(--primary-color); 
      padding: 0.75rem 1rem; 
      border: 1px solid var(--primary-color);
      border-radius: 8px; 
      text-decoration: none; 
      font-weight: 500; 
      transition: var(--transition);
      font-size: 0.9rem;
    }
    .card-details-btn:hover { 
      background: var(--primary-color);
      color: #fff;
    }

    /* ====== Phone link ====== */
    .phone-link { color: var(--primary-color); margin-left: .5rem; text-decoration: none; }

    /* ====== DataTables elements ====== */
    .dataTables_wrapper {
      position: relative;
    }
    
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: var(--text-secondary);
      font-size: .85rem;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button { border: 1px solid var(--border-light); border-radius: var(--radius-sm); margin: 0 .25rem; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: var(--primary-color); color: #fff !important; }
    
    /* ====== Fix DataTables scroll containers ====== */
    .dataTables_scrollHead {
      position: sticky;
      top: 80px;
      z-index: 45;
      background: #fff;
    }

    /* Desktop: DataTables scroll head within container */
    @media (min-width: 1201px) {
      .dataTables_scrollHead {
        top: 0;
      }
    }
    
    .dataTables_scrollHeadInner {
      position: relative;
      width: 100% !important;
    }
    
    .dataTables_scrollHeadInner table {
      margin-bottom: 0 !important;
    }

    /* ====== Responsive tweaks ====== */
    @media (max-width: 1200px) { 
      .desktop-table { display: none; } 
      .mobile-card-container { display: flex; }
      /* Điều chỉnh search section cho mobile */
      .search-section {
        padding: 0.75rem 1rem;
        margin: -1rem -1rem 1.5rem -1rem;
      }
      #courses thead th {
        top: 70px; /* Giảm cho mobile */
      }
      .dataTables_scrollHead {
        top: 70px;
      }
    }
    @media (max-width: 768px)  { 
      body { padding: 1rem; } 
      .content-area { padding: 1rem; }
      .app-header { padding: 1.5rem; }
      .search-section {
        padding: 0.75rem 1rem;
        margin: -1rem -1rem 1.5rem -1rem;
      }
      #courses thead th {
        top: 65px; /* Giảm cho mobile */
      }
      .dataTables_scrollHead {
        top: 65px;
      }
    }
    @media (max-width: 480px)  { 
      .app-header h1 { font-size: 1.5rem; } 
      .app-header .subtitle { font-size: .9rem; }
      .app-header { padding: 1.25rem; }
      .card-footer {
        flex-direction: column;
      }
      .card-register-btn, .card-details-btn {
        text-align: center;
      }
      .search-input {
        padding: 0.75rem 1rem 0.75rem 2.75rem;
      }
      .search-icon {
        left: 1rem;
      }
      #courses thead th {
        top: 60px; /* Giảm hơn cho mobile nhỏ */
      }
      .dataTables_scrollHead {
        top: 60px;
      }
    }

    /* ====== Special Course Highlight ====== */
    .card-title.special-course-highlight,
    .upcoming-tile a.special-course-highlight,
    #courses tbody td.special-course-highlight {
      color: #dc2626 !important;
      font-weight: 700 !important;
    }

    /* ====== Upcoming desktop tiles ====== */
    .upcoming-carousel-wrapper {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.25rem;
      position: relative;
      width: 100%;
      margin: 0 auto 2rem auto;
    }

    /* Desktop: Static highlights */
    @media (min-width: 1201px) {
      .upcoming-carousel-wrapper {
        flex-shrink: 0;
        margin-bottom: 1.5rem;
      }
    }

    .upcoming-tile {
      border-radius: 12px;
      color: #fff;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      position: relative;
      overflow: hidden;
    }

    @media (max-width: 1200px) {
      .upcoming-carousel-wrapper { display: none; }
    }

    .upcoming-tile h3{
      font-size:18px;
      font-weight:700;
      margin:0 0 .75rem 0;
      text-align:center;
      line-height: 1.3; /* Thêm để tiêu đề dài hiển thị tốt hơn */
    }
    .upcoming-tile .tile-divider{
      position:absolute;
      top:46px;
      left:0;
      width:100%;
      height:2px;
      background:rgba(255,255,255,.5);
    }
    .upcoming-tile ul{
      list-style:none;
      margin:0;
      padding:.5rem 0 0 0;
      font-size:.95rem; /* Tăng kích thước nội dung */
      line-height:1.4;
      max-height:180px; 
      overflow:auto;
      /* Custom scrollbar styles */
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.3) transparent;
    }
    /* Webkit scrollbar styles */
    .upcoming-tile ul::-webkit-scrollbar {
      width: 6px;
    }
    .upcoming-tile ul::-webkit-scrollbar-track {
      background: transparent;
    }
    .upcoming-tile ul::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,.3);
      border-radius: 3px;
    }
    .upcoming-tile ul::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255,255,255,.5);
    }
    .upcoming-tile li+li{margin-top:.5rem;padding-top:.5rem;border-top:1px solid rgba(255,255,255,.25);}    

    /* Tile theme colors */
    #tile-hcm    {background:#FFFBEC;} /* vàng siêu nhạt */
    #tile-hn     {background:#E3FFFF;} /* Light Cyan */
    #tile-other  {background:#FFEBFC;} /* hồng siêu nhạt */
    #tile-online {background:#3b82f6;} /* zoom blue */

    /* Override special course color for Online tile to be white */
    #tile-online .special-course-highlight {
      color: #fff !important;
    }

    /* Custom styles for HN tile due to light background */
    #tile-hn,
    #tile-hn h3,
    #tile-hn .course-name,
    #tile-hn .course-date,
    #tile-hn .course-location {
      color: #398398; /* New color as requested */
    }

    #tile-hn .tile-divider {
      background: rgba(57, 131, 152, 0.2);
    }

    #tile-hn li+li {
      border-top-color: rgba(57, 131, 152, 0.6);
    }

    #tile-hn .course-name:hover {
      opacity: 0.7;
    }

    #tile-hn ul {
      scrollbar-color: rgba(57, 131, 152, 0.6) transparent;
    }
    #tile-hn ul::-webkit-scrollbar-thumb {
      background-color: rgba(57, 131, 152, 0.6);
    }
    #tile-hn ul::-webkit-scrollbar-thumb:hover {
      background-color: rgba(57, 131, 152, 0.6);
    }

    .upcoming-tile ul li{
      display:flex;
      justify-content:space-between;
      gap:.5rem;
      align-items:baseline;
    }
    .upcoming-tile .course-name{
      flex:1;
      word-break:break-word;
      color: #fff;
      text-decoration: none;
      transition: opacity 0.2s ease;
      font-size: 15px;
    }
    .upcoming-tile .course-name:hover {
      opacity: 0.8;
    }
    .upcoming-tile .course-date{
      white-space:nowrap;
      font-size: 15px;
    }
    .upcoming-tile .course-title-group {
      flex: 1; /* Group (name+loc) will take available space */
    }

    .upcoming-tile .course-title-group .course-name {
      flex: none; /* Reset flex property for course-name inside the group */
    }

    .upcoming-tile .course-location{
      display: inline-block;
      font-size: 15px;
      color: rgba(255, 255, 255, 0.8);
      margin-left: 0.4rem;
      vertical-align: baseline;
    }

    /* Custom styles for HCM tile due to light background */
    #tile-hcm,
    #tile-hcm h3,
    #tile-hcm .course-name,
    #tile-hcm .course-date,
    #tile-hcm .course-location {
      color: #1D3F59;
    }

    #tile-hcm .tile-divider {
      background: rgba(29, 63, 89, 0.1);
    }

    #tile-hcm li+li {
      border-top-color: rgba(29, 63, 89, 0.15);
    }

    #tile-hcm .course-name:hover {
      opacity: 0.7;
    }

    #tile-hcm ul {
      scrollbar-color: rgba(29, 63, 89, 0.25) transparent;
    }
    #tile-hcm ul::-webkit-scrollbar-thumb {
      background-color: rgba(29, 63, 89, 0.25);
    }
    #tile-hcm ul::-webkit-scrollbar-thumb:hover {
      background-color: rgba(29, 63, 89, 0.4);
    }

    /* Custom styles for Other tile */
    #tile-other,
    #tile-other h3,
    #tile-other .course-name,
    #tile-other .course-date,
    #tile-other .course-location {
      color: #1D3F59;
    }

    #tile-other .tile-divider {
      background: rgba(29, 63, 89, 0.1);
    }

    #tile-other li+li {
      border-top-color: rgba(29, 63, 89, 0.25);
    }

    #tile-other .course-name:hover {
      opacity: 0.8;
    }

    #tile-other ul {
      scrollbar-color: rgba(29, 63, 89, 0.3) transparent;
    }
    #tile-other ul::-webkit-scrollbar-thumb {
      background-color: rgba(29, 63, 89, 0.3);
    }
    #tile-other ul::-webkit-scrollbar-thumb:hover {
      background-color: rgba(29, 63, 89, 0.5);
    }

    /* ====== Mobile Custom Scrollbar ====== */
    @media (max-width: 1200px) {
      /* Custom scrollbar cho mobile container */
      body {
        scrollbar-width: thin;
        scrollbar-color: rgba(79, 70, 229, 0.4) transparent;
      }
      
      body::-webkit-scrollbar {
        width: 8px;
      }
      
      body::-webkit-scrollbar-track {
        background: transparent;
      }
      
      body::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, rgba(79, 70, 229, 0.6) 0%, rgba(124, 58, 237, 0.6) 100%);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, rgba(79, 70, 229, 0.8) 0%, rgba(124, 58, 237, 0.8) 100%);
      }
    }

    /* ====== Mobile Scroll Indicator ====== */
    .mobile-scroll-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(46, 199, 190, 0.7); /* Màu xanh ngọc nhạt với opacity 70% */
      color: white;
      padding: 12px 16px;
      border-radius: 50px;
      box-shadow: 0 4px 20px rgba(46, 199, 190, 0.2);
      display: none; /* Hidden by default */
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      max-width: calc(100vw - 40px);
    }

    .mobile-scroll-indicator.visible {
      display: flex;
      animation: slideInUp 0.4s ease-out;
    }

    .mobile-scroll-indicator.hiding {
      animation: slideOutDown 0.3s ease-in forwards;
    }

    .mobile-scroll-indicator-icon {
      font-size: 16px;
      animation: bounce 2s infinite;
    }

    .mobile-scroll-indicator-text {
      white-space: nowrap;
      font-family: 'Be Vietnam Pro', sans-serif;
    }

    /* Animations */
    @keyframes slideInUp {
      from {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideOutDown {
      from {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      to {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
      }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-4px);
      }
      60% {
        transform: translateY(-2px);
      }
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 768px) {
      .mobile-scroll-indicator {
        bottom: 16px;
        padding: 10px 14px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .mobile-scroll-indicator {
        bottom: 12px;
        padding: 8px 12px;
        border-radius: 40px;
        font-size: 12px;
      }
    }

    /* Hide text only on very small screens (≤250px) */
    @media (max-width: 250px) {
      .mobile-scroll-indicator-text {
        display: none; /* Hide text on extremely small screens, keep only icon */
      }
      
      .mobile-scroll-indicator {
        padding: 6px 10px;
        border-radius: 30px;
      }
    }

    /* Hide scroll indicator on desktop */
    @media (min-width: 1201px) {
      .mobile-scroll-indicator {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">

    <main class="content-area">
      <!-- ▸ Desktop upcoming highlight -->
      <section id="desktopHighlights" class="upcoming-carousel-wrapper"></section>

      <!-- ▸ Search -->
      <section class="search-section">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input id="globalSearch" class="search-input"
                 placeholder="Tìm kiếm thông tin khóa học, giảng viên, địa điểm..."
                 autocomplete="off">
        </div>
      </section>

      <!-- ▸ Desktop table -->
      <div class="desktop-table">
        <div class="table-container">
          <table id="courses" class="display nowrap">
            <thead>
              <tr>
                <th>KHÓA HỌC</th>
                <th>GIẢNG VIÊN</th>
                <th>THỜI GIAN</th>
                <th>ĐỊA ĐIỂM</th>
                <th>HÌNH THỨC</th>
                <!-- <th>Học phí</th> -->
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ▸ Mobile cards -->
      <div id="mobileCardContainer" class="mobile-card-container"></div>
    </main>
  </div>

  <!-- ▸ Mobile Scroll Indicator -->
  <div id="mobileScrollIndicator" class="mobile-scroll-indicator">
    <i class="fas fa-chevron-down mobile-scroll-indicator-icon"></i>
    <span class="mobile-scroll-indicator-text">Vuốt để xem thêm</span>
  </div>

<script>
  const specialCourses = ["Chánh Kiến 1", "Nhân Tướng Học", "Rèn Trí Sáng Suốt", "Rèn Tâm Vững Vàng"];

  /* ========================================================================
   *  Helper: bỏ dấu tiếng Việt & loại ký tự đặc biệt
   * ======================================================================*/
  const stripVN = str =>
    (str || '')
      .toString()
      .normalize('NFD')                // tách dấu
      .replace(/[\u0300-\u036f]/g, '') // bỏ dấu
      .replace(/đ/g, 'd').replace(/Đ/g, 'D')
      .replace(/[^\w\s]/g, '')         // bỏ ký tự lạ (₫, ., , ...)
      .toLowerCase();

  const VND = n => {
    if (typeof n === 'string') return n; // Handle "Liên hệ", "Miễn phí", etc.
    return (n || 0).toLocaleString('vi-VN') + ' vnđ';
  };
  const parseNum = t => {
    const num = parseInt(String(t).replace(/[^\d]/g, '')) || 0;
    // Keep original string if it's not a standard number
    if (typeof t === 'string' && !/^\d+(\.\d{3})*$/.test(t.replace(/\D/g, ''))) {
      return t;
    }
    return num;
  };


  const createModeBadge = mode => {
    const online = /online|zoom|trực tuyến/i.test(mode);
    const hybrid = /hybrid|kết hợp/i.test(mode);
    let cls, icon;
    if (online)      [cls, icon] = ['online',  'fa-video'];
    else if (hybrid) [cls, icon] = ['hybrid',  'fa-people-arrows'];
    else             [cls, icon] = ['offline', 'fa-chalkboard-teacher'];
    return `<span class="mode-badge ${cls}"><i class="fas ${icon}"></i> ${mode || '?'}</span>`;
  };

  /* ====== Custom sort for DD/MM/YYYY & VND ====== */
  $.fn.dataTable.ext.type.order['ddmmyyyy-pre'] = d => {
    if (!d || d.includes('--')) return 0;
    const [dd, mm, yyyy] = d.split('/') || [];
    return new Date(yyyy, mm - 1, dd).getTime() || 0;
  };
  $.fn.dataTable.ext.type.order['vnd-pre'] = t => typeof t === 'string' ? 0 : parseNum(t); // Treat non-numeric fees as 0 for sorting

  /* ----------------------------------------------------------------------
   *  🔍  Accent-insensitive, number-friendly SEARCH plug-in
   * -------------------------------------------------------------------- */
  $.fn.dataTable.ext.search.push((settings, data, dataIndex, rowData) => {
    const query = stripVN($('#globalSearch').val().trim().toLowerCase());
    if (!query) return true;

    // Kiểm tra từng cột của dữ liệu gốc
    // rowData ở đây đã ở định dạng cuối cùng (start, end, speaker, course, etc.)
    return Object.values(rowData).some(val => {
      // Nếu là học phí dạng string ("Liên hệ", "Miễn phí"), vẫn tìm kiếm trên chuỗi đó
      if (typeof val === 'string' && (val === 'Liên hệ' || val === 'Miễn phí' || val === 'TÙY HỶ')) {
        return stripVN(val).includes(query);
      }
      if (typeof val === 'number') {
        // Xử lý số tiền (fee)
        return stripVN(VND(val)).includes(query) || String(val).includes(query);
      }
      // Xử lý chuỗi (bao gồm HTML)
      const text = typeof val === 'string' ? val : String(val);
      return stripVN($('<div>').html(text).text()).includes(query);
    });
  });

  /* ========================================================================
   *  Data fetching
   * ======================================================================*/
  async function getData() {
    try {
      const res = await fetch('https://webhook.gnh.vn/webhook/event_info', { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status);
      const raw = await res.json(); // raw is an array of objects from the webhook

      return raw
        .filter(x => x.course && x.speaker) // Keep this filter for API data
        .map(x => {
          let processedFee;
          // Use 'tuition' from API directly, as it's the expected field
          if (x.tuition === "Liên hệ" || x.tuition === "liên hệ" || x.tuition === "MIỄN PHÍ" || x.tuition === "TÙY HỶ") {
            processedFee = x.tuition; // Keep as string for these special cases
          } else if (!x.tuition || x.tuition === "" || x.tuition === null) {
            processedFee = "--";
          } else {
            processedFee = parseNum(x.tuition); // Parse number for numeric values
          }

          // Assume x.href is the primary link from the API for the main object
          // If the API provided specific fields like 'Chi tiết (link)' or 'Đăng ký (link)'
          // they would need to be handled here. For now, sticking to x.href as the main one.
          const finalHref = x.href || '#';

          return {
            start: x.start_date || '--/--/----',
            end: x.end_date || '--/--/----',
            speaker: x.speaker,
            course: x.course,
            loc: x.location || 'N/A',
            mode: x.learning_mode || 'N/A',
            fee: processedFee,
            href: finalHref,
            thumbnail: x.thumbnail || '',
            description: x.description || '',
            categories: x.categories || ''
          };
        });
    } catch (err) {
      console.warn('API lỗi, dùng dữ liệu dự phòng:', err);
      // Dữ liệu dự phòng đã được chuyển đổi SẴN sang định dạng mong muốn
      // (start, end, speaker, course, loc, mode, fee, href, thumbnail, description, categories)
      return [
        {
          start: '03/08/2025', end: '03/08/2025', speaker: 'Coach Thắng Huyền Đức', course: 'Workshop Đội ngũ', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình Doanh nghiệp', fee: 'Liên hệ', href: 'https://bke.edu.vn/wsthucchien', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/screenshot_1739867654-20250218083501-wdo7_.png', description: 'Workshop 1 ngày Thực chiến tại Hà Nội - HCM - Dành cho chủ doanh nghiệp và đội ngũ'
        },
        {
          start: '16/08/2025', end: '17/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh Kiến 1', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình 3 Gốc', fee: 1900000, href: 'https://bke.edu.vn/chanhkien1', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/ck1-banner-01-20220602030602.jpg', description: 'Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình'
        },
        {
          start: '27/09/2025', end: '28/09/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh Kiến 2', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình 3 Gốc', fee: 2900000, href: 'https://bke.edu.vn/chanhkien2', thumbnail: 'https://w.ladicdn.com/s292x164/5e8449c2481e7d0f79868b5d/ck2-01-20220214103634.jpg', description: 'Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình'
        },
        {
          start: '02/07/2025', end: '02/07/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thuật dụng nhân', loc: 'Hà Nội', mode: 'Offline', categories: 'Hành trình Doanh nghiệp', fee: 499000, href: 'https://bke.edu.vn/dungnhan', thumbnail: '', description: ''
        },
        {
          start: '16/07/2025', end: '16/07/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thuật dụng nhân', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình Doanh nghiệp', fee: 499000, href: 'https://bke.edu.vn/dungnhan', thumbnail: '', description: ''
        },
        {
          start: '08/07/2025', end: '10/07/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thấu hiểu nhân tâm', loc: 'Zoom', mode: 'Zoom', categories: 'Lớp học Gieo duyên cộng đồng', fee: 399000, href: 'https://bke.edu.vn/nhantam/', thumbnail: '', description: ''
        },
        {
          start: '05/07/2025', end: '09/07/2025', speaker: 'Cô Nguyễn Đoàn Kim Sơn', course: 'Lãnh đạo chính mình', loc: 'Zoom', mode: 'Zoom', categories: 'Lãnh đạo chính mình - Tỉnh thức', fee: 1500000, href: 'https://gnh.vn/LDCM_K32', thumbnail: '', description: ''
        },
        {
          start: '21/09/2025', end: '21/09/2025', speaker: 'Coach Thắng Huyền Đức', course: 'Leader 10x', loc: 'Zoom', mode: 'Zoom', categories: 'Hành trình Doanh nghiệp', fee: 30000000, href: 'https://bke.edu.vn/10x', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/leader-10x-20250512041107-go4gq.png', description: 'Hành trình chuyển hóa 10 tuần để khám phá và lãnh đạo chính bản thân, giải phóng niềm tin giới hạn, xây dựng môi trường sống tích cực, và sống cuộc đời ý nghĩa.'
        },
        {
          start: '04/10/2025', end: '05/10/2025', speaker: 'Thầy Trần Việt Quân', course: 'Nhân Tướng Học', loc: 'Hà Nội', mode: 'Offline', categories: 'Đọc vị Giải mã sự nghiệp', fee: 6900000, href: 'https://bke.edu.vn/nhantuong', thumbnail: 'https://w.ladicdn.com/s289x164/5e8449c2481e7d0f79868b5d/banner-01-20220214044916.jpg', description: 'Giúp bạn soi mình, hiểu mình và sửa mình. Giúp bạn nhìn người, hiểu người & giúp người'
        },
        {
          start: '30/07/2025', end: '30/07/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thấu hiểu nhân tâm', loc: 'Hà Nội', mode: 'Offline', categories: 'Đọc vị Giải mã sự nghiệp', fee: 499000, href: 'https://bke.edu.vn/nhantamoff', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/share-web-01-20221214070703-rnux3.jpg', description: ''
        },
        {
          start: '13/08/2025', end: '13/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thấu hiểu nhân tâm', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Đọc vị Giải mã sự nghiệp', fee: 499000, href: 'https://bke.edu.vn/nhantamoff', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/share-web-01-20221214070703-rnux3.jpg', description: ''
        },
        {
          start: '11/10/2025', end: '12/10/2025', speaker: 'Thầy Trần Việt Quân', course: 'Xây Dựng Đội Ngũ', loc: 'Hà Nội', mode: 'Offline', categories: 'Hành trình Doanh nghiệp', fee: 6900000, href: 'https://bke.edu.vn/team', thumbnail: 'https://w.ladicdn.com/s292x164/5e8449c2481e7d0f79868b5d/team-20241016055944-_2iwu.png', description: 'Một DN mạnh không cần những con người rời rạc. Một doanh nghiệp mạnh cần một đội ngũ mạnh & gắn kết'
        },
        {
          start: '18/10/2025', end: '19/10/2025', speaker: 'Thầy Trần Việt Quân', course: 'Nhân Tướng Học', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Đọc vị Giải mã sự nghiệp', fee: 6900000, href: 'https://bke.edu.vn/nhantuong', thumbnail: 'https://w.ladicdn.com/s289x164/5e8449c2481e7d0f79868b5d/banner-01-20220214044916.jpg', description: 'Giúp bạn soi mình, hiểu mình và sửa mình. Giúp bạn nhìn người, hiểu người & giúp người'
        },
        {
          start: '08/09/2025', end: '31/10/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh kiến Học Hiểu Hành', loc: 'Zoom', mode: 'Zoom', categories: 'Hành trình 3 Gốc', fee: 3200000, href: 'https://bke.edu.vn/ck3h', thumbnail: 'https://w.ladicdn.com/s289x162/5e8449c2481e7d0f79868b5d/z5688760085770_7376ba05524391bcdec81d8e64a63e74-20240801072109-tv3h7.jpg', description: 'Nắm trọn vẹn bí quyết được thầy Trần Việt Quân đúc kết suốt 25 năm Thực Hành Chuyển Hóa ngay tại lớp'
        },
        {
          start: '31/07/2025', end: '31/07/2025', speaker: 'Thầy Trần Việt Quân', course: 'Gieo duyên cộng đồng', loc: 'Hà Tĩnh', mode: 'Offline', categories: 'Lớp học Gieo duyên cộng đồng', fee: 'Miễn phí', href: 'https://zalo.me/g/uarrqk708', thumbnail: '', description: ''
        },
        {
          start: '01/08/2025', end: '01/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Gieo duyên cộng đồng', loc: 'Thanh Hóa', mode: 'Offline', categories: 'Lớp học Gieo duyên cộng đồng', fee: 'Miễn phí', href: 'https://zalo.me/g/dslhif627', thumbnail: '', description: ''
        },
        {
          start: '05/08/2025', end: '07/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thấu hiểu nhân tâm (Tối)', loc: 'Zoom', mode: 'Zoom', categories: 'Lớp học Gieo duyên cộng đồng', fee: 399000, href: 'https://bke.edu.vn/nhantam/', thumbnail: '', description: ''
        },
        {
          start: '26/08/2025', end: '28/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thấu hiểu nhân tâm (Sáng)', loc: 'Zoom', mode: 'Zoom', categories: 'Lớp học Gieo duyên cộng đồng', fee: 399000, href: 'https://bke.edu.vn/nhantam/', thumbnail: '', description: ''
        },
        {
          start: '11/08/2025', end: '11/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Gieo duyên cộng đồng', loc: 'Quảng Trị', mode: 'Offline', categories: 'Lớp học Gieo duyên cộng đồng', fee: 'Miễn phí', href: 'https://ybai.co/gjwdvp5847', thumbnail: '', description: ''
        },
        {
          start: '06/09/2025', end: '07/09/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh Kiến 1', loc: 'Hà Nội', mode: 'Offline', categories: 'Hành trình 3 Gốc', fee: 1900000, href: 'https://bke.edu.vn/chanhkien1', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/ck1-banner-01-20220602030602.jpg', description: 'Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình'
        },
        {
          start: '09/08/2025', end: '10/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Ngày hội Giáo viên 3 gốc', loc: 'Hà Nội', mode: 'Offline', categories: 'Lớp học Gieo duyên cộng đồng', fee: 500000, href: 'https://bke.edu.vn/giaovien3goc', thumbnail: '', description: ''
        },
        {
          start: '23/08/2025', end: '24/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Ngày hội Giáo viên 3 gốc', loc: 'Vabis Vũng Tàu', mode: 'Offline', categories: 'Lớp học Gieo duyên cộng đồng', fee: 500000, href: 'https://bke.edu.vn/giaovien3goc', thumbnail: '', description: ''
        },
        {
          start: '25/10/2025', end: '26/10/2025', speaker: 'Thầy Trần Việt Quân - NSKT', course: 'Xây Dựng Đội Ngũ', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình Doanh nghiệp', fee: 6900000, href: 'https://bke.edu.vn/team', thumbnail: 'https://w.ladicdn.com/s292x164/5e8449c2481e7d0f79868b5d/team-20241016055944-_2iwu.png', description: 'Một DN mạnh không cần những con người rời rạc. Một doanh nghiệp mạnh cần một đội ngũ mạnh & gắn kết'
        },
        {
          start: '19/08/2025', end: '21/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Thấu hiểu nhân tâm (Tối)', loc: 'Zoom', mode: 'Zoom', categories: 'Lớp học Gieo duyên cộng đồng', fee: 399000, href: 'https://bke.edu.vn/nhantam/', thumbnail: '', description: ''
        },
        {
          start: '12/08/2025', end: '14/08/2025', speaker: 'Thầy Trần Việt Quân', course: 'Bí mật tình yêu hôn nhân (Tối)', loc: 'Zoom', mode: 'Zoom', categories: 'Lớp học Gieo duyên cộng đồng', fee: 'MIỄN PHÍ', href: 'https://bke.edu.vn/honnhanbenvung/', thumbnail: '', description: ''
        },
        {
          start: '20/09/2025', end: '21/09/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh Kiến 1', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình 3 Gốc', fee: 1900000, href: 'https://bke.edu.vn/chanhkien1', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/ck1-banner-01-20220602030602.jpg', description: 'Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình'
        },
        {
          start: '09/09/2025', end: '11/09/2025', speaker: 'Thầy Trần Việt Quân', course: 'Bí mật tình yêu hôn nhân (Tối)', loc: 'Zoom', mode: 'Zoom', categories: 'Lớp học Gieo duyên cộng đồng', fee: 'MIỄN PHÍ', href: 'https://bke.edu.vn/honnhanbenvung/', thumbnail: '', description: ''
        },
        {
          start: '17/09/2025', end: '17/09/2025', speaker: 'Thầy Trần Việt Quân', course: 'Gieo duyên cộng đồng', loc: 'Đà Nẵng', mode: 'Offline', categories: 'Dạy con', fee: 'MIỄN PHÍ', href: 'https://gnh.vn/dayconthanhtai-danang', thumbnail: '', description: ''
        },
        {
          start: '18/09/2025', end: '18/09/2025', speaker: 'Thầy Trần Việt Quân', course: 'Gieo duyên cộng đồng', loc: 'Đà Nẵng', mode: 'Offline', categories: 'Hành trình Doanh nghiệp', fee: 'TÙY HỶ', href: 'https://gnh.vn/Dky_LanhDaoTinhThuc', thumbnail: '', description: ''
        },
        {
          start: '08/11/2025', end: '09/11/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh Kiến 1', loc: 'Hà Nội', mode: 'Offline', categories: 'Hành trình 3 Gốc', fee: 1900000, href: 'https://bke.edu.vn/chanhkien1', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/ck1-banner-01-20220602030602.jpg', description: 'Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình'
        },
        {
          start: '13/12/2025', end: '14/12/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh Kiến 2', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình 3 Gốc', fee: 2900000, href: 'https://bke.edu.vn/chanhkien2', thumbnail: 'https://w.ladicdn.com/s292x164/5e8449c2481e7d0f79868b5d/ck2-01-20220214103634.jpg', description: 'Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình'
        },
        {
          start: '22/11/2025', end: '23/11/2025', speaker: 'Thầy Trần Việt Quân', course: 'Chánh Kiến 1', loc: 'Hồ Chí Minh', mode: 'Offline', categories: 'Hành trình 3 Gốc', fee: 1900000, href: 'https://bke.edu.vn/chanhkien1', thumbnail: 'https://w.ladicdn.com/5e8449c2481e7d0f79868b5d/ck1-banner-01-20220602030602.jpg', description: 'Hành trình 2 ngày đêm giúp bạn hiểu sâu phương pháp thực hành để tìm ra hạnh phúc đích thực cho chính mình'
        }
      ];
    }
  }

  /* ========================================================================
   *  Mobile card renderer
   * ======================================================================*/
  function fillCards(data) {
    const container = $('#mobileCardContainer').empty();
    if (!data || !data.length) {
      container.html('<p style="text-align:center;padding:1.5rem;color:var(--text-muted)">Không tìm thấy khóa học phù hợp.</p>');
      return;
    }

    // Dữ liệu cho cards giờ đã được lọc trước khi gọi hàm này.
    // Chỉ cần sắp xếp theo ngày bắt đầu (gần nhất ở đầu).
    const sortedData = [...data].sort((a, b) => {
      // Hàm chuyển đổi DD/MM/YYYY thành Date object
      const parseDate = (dateStr) => {
        if (!dateStr || dateStr.includes('--')) return new Date(0); // Ngày xa nhất nếu không có
        const [dd, mm, yyyy] = dateStr.split('/');
        return new Date(yyyy, mm - 1, dd); // mm - 1 vì tháng trong JS bắt đầu từ 0
      };

      const dateA = parseDate(a.start);
      const dateB = parseDate(b.start);

      // Sắp xếp tăng dần (ngày gần nhất ở đầu)
      return dateA.getTime() - dateB.getTime();
    });

    const getModeBadgeClass = mode => {
      const online = /online|zoom|trực tuyến/i.test(mode);
      const hybrid = /hybrid|kết hợp/i.test(mode);
      return online ? 'online' : hybrid ? 'hybrid' : 'offline';
    };

    const getModeIcon = mode => {
      const online = /online|zoom|trực tuyến/i.test(mode);
      const hybrid = /hybrid|kết hợp/i.test(mode);
      return online ? 'fa-video' : hybrid ? 'fa-people-arrows' : 'fa-chalkboard-teacher';
    };

    container.html(sortedData.map(c => {
      const isSpecial = specialCourses.includes(c.course);
      const specialClass = isSpecial ? 'special-course-highlight' : '';

      const formatDM = d => {
        if (!d || d.includes('--')) return '??/??';
        const [dd, mm] = d.split('/');
        return `${dd}/${mm}`;
      };

      const dateDisplay = c.start === c.end
        ? formatDM(c.start)
        : `${formatDM(c.start)} - ${formatDM(c.end)}`;

      return `
      <article class="course-card">
        <div class="card-thumbnail-container">
          ${c.thumbnail ?
            `<img src="${c.thumbnail}" alt="${c.course}" class="card-thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
             <div class="card-thumbnail-placeholder" style="display:none;">${c.course}</div>` :
            `<div class="card-thumbnail-placeholder">${c.course}</div>`
          }
        </div>

        <div class="card-header">
          <h3 class="card-title ${specialClass}">${c.course}</h3>
        </div>

        <div class="card-body">
          <div class="card-meta">
            <span class="card-mode-badge ${getModeBadgeClass(c.mode)}">
              <i class="fas ${getModeIcon(c.mode)}"></i>
              ${c.mode}
            </span>
          </div>

          <div class="card-info-grid">
            <div class="card-info-item">
              <i class="fas fa-user info-icon"></i>
              <span class="info-value">${c.speaker}</span>
            </div>
            <div class="card-info-item">
              <i class="fas fa-calendar info-icon"></i>
              <span class="info-value">${dateDisplay}</span>
            </div>
            <div class="card-info-item">
              <i class="fas fa-map-marker-alt info-icon"></i>
              <span class="info-value">${c.loc}</span>
            </div>
            ${c.categories ? `
            <div class="card-info-item">
              <i class="fas fa-tag info-icon"></i>
              <span class="info-value">${c.categories}</span>
            </div>` : ''}
          </div>

          <div class="card-price">${typeof c.fee === 'string' ? c.fee : VND(c.fee)}</div>

          ${c.description ? `<div class="card-description">${c.description}</div>` : ''}
        </div>

        <div class="card-footer">
          <a href="${c.href}" target="_blank" class="card-register-btn">Đăng ký ngay</a>
          <a href="${c.href}" target="_blank" class="card-details-btn">Chi tiết</a>
        </div>
      </article>`}).join(''));

    // Update mobile scroll indicator after cards are rendered
    if (window.updateMobileScrollIndicator) {
      setTimeout(window.updateMobileScrollIndicator, 100);
    }
  }

  /* ====== Debounce helper ====== */
  const debounce = (fn, ms = 250) => {
    let id;
    return (...args) => {
      clearTimeout(id);
      id = setTimeout(() => fn.apply(this, args), ms);
    };
  };

  /* ========================================================================
   *  Desktop Upcoming Highlights renderer
   * ======================================================================*/
  function renderHighlights(courseData){
    const container = $('#desktopHighlights').empty();
    if($(window).width()<1200) return; // only desktop

    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
    const parseDate = (d)=>{ if(!d||d.includes('--')) return null; const [dd,mm,yy]=d.split('/'); return new Date(yy,mm-1,dd); };

    const groups = [
      {id:'hcm',label:'Tại Hồ Chí Minh',  match: c=>/Hồ Chí Minh/i.test(c.loc)},
      {id:'hn', label:'Tại Hà Nội',   match: c=>/Hà Nội/i.test(c.loc)},
      {id:'other',label:'Tỉnh/Thành Phố Khác', match: c=>!/(Hồ Chí Minh|Hà Nội|Zoom)/i.test(c.loc)},
      {id:'online',label:'Trực Tuyến Qua Zoom', match: c=>/zoom/i.test(c.loc)}
    ];

    let htmls = [];
    groups.forEach(g=>{
      // Dữ liệu cho highlights giờ đã được lọc trước, chỉ cần nhóm và sắp xếp.
      const list = courseData
        .filter(c=>g.match(c))
        .sort((a,b)=>parseDate(a.start)-parseDate(b.start));

      const formatDM = d=>{const [dd,mm] = d.split('/'); return `${dd}/${mm}`};
      const items=list.map(c => {
        const specialClass = specialCourses.includes(c.course) ? 'special-course-highlight' : '';
        const dateDisplay = c.start === c.end ? formatDM(c.start) : `${formatDM(c.start)} – ${formatDM(c.end)}`;
        return `<li><a href="${c.href}" target="_blank" class="course-name ${specialClass}">${c.course}</a><span class="course-date">${dateDisplay}</span></li>`;
      }).join('');

      // Special handling for "other" group to show location
      if (g.id === 'other') {
        const itemsWithLocation = list.map(c => {
          const specialClass = specialCourses.includes(c.course) ? 'special-course-highlight' : '';
          const dateDisplay = c.start === c.end ? formatDM(c.start) : `${formatDM(c.start)} – ${formatDM(c.end)}`;
          return `<li>
            <div class="course-title-group">
              <a href="${c.href}" target="_blank" class="course-name ${specialClass}">${c.course}</a>
              <span class="course-location">(${c.loc})</span>
            </div>
            <span class="course-date">${dateDisplay}</span>
          </li>`;
        }).join('');
        const tileContent = `
          <article id="tile-${g.id}" class="upcoming-tile">
            <h3>${g.label}</h3>
            <div class="tile-divider"></div>
            <ul>${itemsWithLocation || '<li>Đang cập nhật…</li>'}</ul>
          </article>`;
        htmls.push(tileContent);
      } else {
        htmls.push(`
          <article id="tile-${g.id}" class="upcoming-tile">
            <h3>${g.label}</h3>
            <div class="tile-divider"></div>
            <ul>${items || '<li>Đang cập nhật…</li>'}</ul>
          </article>`);
      }
    });
    container.html(htmls.join(''));
  }

  /* ========================================================================
   *  Init
   * ======================================================================*/
  $(async () => {
    const allCourseData = await getData();

    // Lọc trước tất cả dữ liệu để chỉ hiển thị các khóa học chưa kết thúc (end_date >= today)
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const parseDateForFilter = (dateStr) => {
        if (!dateStr || dateStr.includes('--')) return null;
        const [dd, mm, yyyy] = dateStr.split('/');
        return new Date(yyyy, mm - 1, dd);
    };
    const courseData = allCourseData.filter(course => {
      const endDate = parseDateForFilter(course.end);
      // Giữ lại khóa học nếu ngày kết thúc của nó lớn hơn hoặc bằng hôm nay
      return endDate ? endDate.getTime() >= today.getTime() : false;
    });

    fillCards(courseData);
    renderHighlights(courseData);

    // Initialize mobile scroll indicator
    initMobileScrollIndicator();

    const dt = $('#courses').DataTable({
      data: courseData,
      columns: [
        { data: 'course' },
        { data: 'speaker' },
        { data: null }, // Placeholder for the combined date range
        { data: 'loc' },
        { data: 'mode' },
        { data: 'start', visible: false }, // Hidden column for sorting
        { data: 'end', visible: false } // Hidden column
      ],
      columnDefs: [
        {
          targets: 2, // The new "Thời gian" column
          orderData: [5], // Sort this column using the 'start' date data (index 5)
          render: function (data, type, row) {
            const formatDM = d => {
              if (!d || d.includes('--')) return '??/??';
              const [dd, mm] = d.split('/');
              return `${dd}/${mm}`;
            };
            return row.start === row.end
              ? formatDM(row.start)
              : `${formatDM(row.start)} - ${formatDM(row.end)}`;
          }
        },
        { type: 'ddmmyyyy', targets: [5] }, // Apply date sorting to the hidden start column
        {
          targets: 3, /* Địa điểm: now at index 3 */
          render: (data) => `${data} ${/^\+?\d/.test(data.trim()) ? `<a href="tel:${data.trim()}" class="phone-link" title="Gọi điện"><i class="fas fa-phone"></i></a>` : ''}`
        },
        { targets: 4, render: (d) => createModeBadge(d) } /* Hình thức: now at index 4 */
      ],
      createdRow: (row, data) => {
        $(row).attr('data-href', data.href);
        if (specialCourses.includes(data.course)) {
          $('td:eq(0)', row).addClass('special-course-highlight');
        }
      },
      order: [[2, 'asc']], // Sort by the new "Thời gian" column
      pageLength: -1, // Hiển thị tất cả entries
      lengthMenu: [], // Ẩn menu length
      dom: 'rt', // Chỉ hiển thị table và processing
      info: false, // Ẩn thông tin số lượng entries
      paging: false, // Ẩn phân trang
      autoWidth: false,
      initComplete: function() {
        const isDesktop = window.innerWidth > 1200;
        const topValue = isDesktop ? '0px' : '80px';

        $('#courses thead th').css({
          'position': 'sticky',
          'top': topValue,
          'z-index': '50',
          'background': '#2EC7BE', /* Màu xanh ngọc nhạt */
          'box-shadow': '0 2px 2px -1px rgba(0, 0, 0, 0.4)'
        });
      },
      drawCallback: function() {
        const isDesktop = window.innerWidth > 1200;
        const topValue = isDesktop ? '0px' : '80px';

        $('#courses thead th').css({
          'position': 'sticky',
          'top': topValue,
          'z-index': '50',
          'background': '#2EC7BE' /* Màu xanh ngọc nhạt */
        });
      }
    });

    /* ▸ Global search: bỏ dấu + đồng bộ hai view */
    $('#globalSearch').on('input', debounce(function () {
      dt.search('').draw(); // Xóa tìm kiếm mặc định để sử dụng plugin tùy chỉnh
    }));

    /* ▸ Handle resize for sticky positioning */
    $(window).on('resize', debounce(function() {
      const isDesktop = window.innerWidth > 1200;
      const topValue = isDesktop ? '0px' : '80px';

      $('#courses thead th').css('top', topValue);
      $('.dataTables_scrollHead').css('top', topValue);
    }, 250));

    dt.on('draw.dt', () => {
      fillCards(dt.rows({ search: 'applied' }).data().toArray());
      // Update scroll indicator after cards are refreshed
      if (window.updateMobileScrollIndicator) {
        setTimeout(window.updateMobileScrollIndicator, 100);
      }
    });

    /* ▸ row click to open */
    $('#courses tbody').on('click', 'tr', function (e) {
      if ($(e.target).closest('a').length) return; /* avoid when clicking phone icon */
      const href = $(this).data('href');
      if (href && href !== '#') window.open(href, '_blank');
    });

    /* ========================================================================
     *  Mobile Scroll Indicator Logic
     * ======================================================================*/
    function initMobileScrollIndicator() {
      const $indicator = $('#mobileScrollIndicator');
      const $mobileContainer = $('#mobileCardContainer');
      let isIndicatorVisible = false;
      let hideTimeout;

      // Kiểm tra xem có phải mobile view không
      function isMobileView() {
        return window.innerWidth <= 1200;
      }

      // Kiểm tra xem có đủ nội dung để scroll không
      function hasScrollableContent() {
        return document.documentElement.scrollHeight > window.innerHeight + 100; // Thêm buffer 100px
      }

      // Kiểm tra xem đã scroll gần đến cuối chưa
      function isNearBottom() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const distanceFromBottom = documentHeight - (scrollTop + windowHeight);

        // Ẩn indicator khi còn cách đáy 150px
        return distanceFromBottom <= 150;
      }

      // Hiển thị indicator với animation smooth
      function showIndicator() {
        if (isIndicatorVisible) return;

        $indicator.removeClass('hiding').addClass('visible');
        isIndicatorVisible = true;

        // Clear any existing hide timeout
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
      }

      // Ẩn indicator với animation smooth
      function hideIndicator() {
        if (!isIndicatorVisible) return;

        $indicator.removeClass('visible').addClass('hiding');
        isIndicatorVisible = false;

        // Hoàn toàn ẩn element sau khi animation kết thúc
        hideTimeout = setTimeout(() => {
          $indicator.removeClass('hiding');
        }, 300); // Match với animation duration
      }

      // Main logic để quyết định hiển thị/ẩn indicator
      function updateIndicatorVisibility() {
        if (!isMobileView()) {
          hideIndicator();
          return;
        }

        // Chỉ hiển thị khi:
        // 1. Đang ở mobile view
        // 2. Có đủ nội dung để scroll
        // 3. Chưa scroll gần đến cuối
        // 4. Mobile container có cards
        if (hasScrollableContent() && !isNearBottom() && $mobileContainer.children().length > 0) {
          showIndicator();
        } else {
          hideIndicator();
        }
      }

      // Throttle scroll events để optimize performance
      let scrollTimeout;
      function throttledScrollHandler() {
        if (scrollTimeout) return;

        scrollTimeout = setTimeout(() => {
          updateIndicatorVisibility();
          scrollTimeout = null;
        }, 16); // ~60fps
      }

      // Event listeners
      $(window).on('scroll', throttledScrollHandler);
      $(window).on('resize', debounce(updateIndicatorVisibility, 250));

      // Initial check
      updateIndicatorVisibility();

      // Expose update function globally để có thể gọi từ bên ngoài
      window.updateMobileScrollIndicator = updateIndicatorVisibility;
    }
  });
</script>
</body>
</html>
